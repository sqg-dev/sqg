// This file is generated by SQG (https://sqg.dev). Do not edit manually.
package generated;

import generated.QueriesJdbc.*;
import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import org.apache.arrow.memory.RootAllocator;
import org.apache.arrow.vector.*;
import org.apache.arrow.vector.complex.ListVector;
import org.apache.arrow.vector.ipc.ArrowReader;
import org.duckdb.DuckDBConnection;
import org.duckdb.DuckDBResultSet;

public class Queries {

    private final DuckDBConnection connection;
    private final QueriesJdbc jdbc;

    public Queries(DuckDBConnection connection) {
        this.connection = connection;
        this.jdbc = new QueriesJdbc(connection);
    }

    public static List<String> getMigrations() {
        return QueriesJdbc.getMigrations();
    }

    public record DailyMetricsResult(
        PreparedStatement statement,
        RootAllocator allocator,
        ArrowReader reader,
        DateDayVector day,
        BigIntVector events,
        BigIntVector unique_users,
        BigIntVector conversions
    ) implements AutoCloseable {
        public boolean loadNextBatch() throws IOException {
            return reader.loadNextBatch();
        }

        public int getRowCount() throws IOException {
            return reader.getVectorSchemaRoot().getRowCount();
        }

        public void close() throws IOException, SQLException {
            reader.close();
            allocator.close();
            statement.close();
        }
    }

    public DailyMetricsResult dailyMetrics(String start_date, String end_date)
        throws SQLException, IOException {
        var stmt = connection.prepareStatement(
            """
            SELECT
              DATE_TRUNC('day', timestamp) as day,
              COUNT(*) as events,
              COUNT(DISTINCT user_id) as unique_users,
              COUNT(*) FILTER (WHERE event_type = 'conversion') as conversions
            FROM events
            WHERE timestamp BETWEEN ? AND ?
            GROUP BY 1
            ORDER BY 1;"""
        );
        stmt.setObject(1, start_date);
        stmt.setObject(2, end_date);
        var rs = (DuckDBResultSet) stmt.executeQuery();
        var allocator = new RootAllocator();
        var reader = (ArrowReader) rs.arrowExportStream(allocator, 65536);
        var root = reader.getVectorSchemaRoot();

        return new DailyMetricsResult(
            stmt,
            allocator,
            reader,
            (DateDayVector) root.getVector("day"),
            (BigIntVector) root.getVector("events"),
            (BigIntVector) root.getVector("unique_users"),
            (BigIntVector) root.getVector("conversions")
        );
    }

    public record TopPagesResult(
        PreparedStatement statement,
        RootAllocator allocator,
        ArrowReader reader,
        VarCharVector page,
        BigIntVector views,
        BigIntVector unique_visitors
    ) implements AutoCloseable {
        public boolean loadNextBatch() throws IOException {
            return reader.loadNextBatch();
        }

        public int getRowCount() throws IOException {
            return reader.getVectorSchemaRoot().getRowCount();
        }

        public void close() throws IOException, SQLException {
            reader.close();
            allocator.close();
            statement.close();
        }
    }

    public TopPagesResult topPages(Integer limit_count)
        throws SQLException, IOException {
        var stmt = connection.prepareStatement(
            """
            SELECT
              properties.page as page,
              COUNT(*) as views,
              COUNT(DISTINCT user_id) as unique_visitors
            FROM events
            WHERE event_type = 'pageview'
            GROUP BY 1
            ORDER BY views DESC
            LIMIT ?;"""
        );
        stmt.setObject(1, limit_count);
        var rs = (DuckDBResultSet) stmt.executeQuery();
        var allocator = new RootAllocator();
        var reader = (ArrowReader) rs.arrowExportStream(allocator, 65536);
        var root = reader.getVectorSchemaRoot();

        return new TopPagesResult(
            stmt,
            allocator,
            reader,
            (VarCharVector) root.getVector("page"),
            (BigIntVector) root.getVector("views"),
            (BigIntVector) root.getVector("unique_visitors")
        );
    }
}

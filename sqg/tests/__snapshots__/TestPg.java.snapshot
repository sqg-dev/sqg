// This file is generated by SQG (https://sqg.dev). Do not edit manually.
package com.test;

import java.math.BigDecimal;
import java.math.BigInteger;
import java.sql.Array;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Struct;
import java.time.Instant;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.OffsetDateTime;
import java.time.OffsetTime;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.UUID;
import java.util.function.Function;

public class TestPg {

    private final Connection connection;

    public TestPg(Connection connection) {
        this.connection = connection;
    }

    private static Object[] getObjectArray(Array array) {
        if (array == null) {
            return null;
        }
        try {
            return (Object[]) array.getArray();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    private static Object[] getAttr(Struct struct) {
        if (struct == null) {
            return null;
        }
        try {
            return struct.getAttributes();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    private static LocalDateTime toLocalDateTime(java.sql.Timestamp ts) {
        return ts != null ? ts.toLocalDateTime() : null;
    }

    private static LocalDate toLocalDate(java.sql.Date d) {
        return d != null ? d.toLocalDate() : null;
    }

    private static LocalTime toLocalTime(java.sql.Time t) {
        return t != null ? t.toLocalTime() : null;
    }

    private static OffsetDateTime toOffsetDateTime(java.sql.Timestamp ts) {
        return ts != null
            ? ts.toInstant().atOffset(java.time.ZoneOffset.UTC)
            : null;
    }

    private static <K> List<K> arrayToList(
        Array array,
        Class<? extends K[]> baseType
    ) {
        var objectArray = getObjectArray(array);
        if (objectArray == null) {
            return null;
        }
        return Collections.unmodifiableList(
            Arrays.asList(
                Arrays.copyOf(objectArray, objectArray.length, baseType)
            )
        );
    }

    private static <K> List<K> arrayOfStructToList(
        Array array,
        Function<Object[], K> convert
    ) {
        var objectArray = getObjectArray(array);
        if (objectArray == null) {
            return null;
        }
        var list = new ArrayList<K>(objectArray.length);
        for (Object obj : objectArray) {
            list.add(obj != null ? convert.apply(getAttr((Struct) obj)) : null);
        }
        return Collections.unmodifiableList(list);
    }

    @SuppressWarnings("unchecked")
    private static <K> List<List<K>> multiDimArrayToList(
        Array array,
        Class<? extends K[]> baseType
    ) {
        var objectArray = getObjectArray(array);
        if (objectArray == null) {
            return null;
        }
        var list = new ArrayList<List<K>>(objectArray.length);
        for (Object obj : objectArray) {
            if (obj == null) {
                list.add(null);
            } else if (obj instanceof Array) {
                list.add(arrayToList((Array) obj, baseType));
            } else if (obj instanceof Object[]) {
                var inner = (Object[]) obj;
                list.add(
                    Collections.unmodifiableList(
                        Arrays.asList(
                            Arrays.copyOf(inner, inner.length, baseType)
                        )
                    )
                );
            } else {
                throw new RuntimeException(
                    "Unexpected type in multi-dimensional array: " +
                        obj.getClass()
                );
            }
        }
        return Collections.unmodifiableList(list);
    }

    private static final List<String> migrations = List.of(
        """
        create table users (
            id text primary key,
            name text not null,
            email text unique
        );

        CREATE TYPE task_status AS ENUM ('pending', 'active', 'completed', 'cancelled');

        CREATE TABLE tasks (
            id SERIAL PRIMARY KEY,
            title TEXT NOT NULL,
            status task_status DEFAULT 'pending',
            tags TEXT[],
            priority_scores INTEGER[]
        );"""
    );

    public static List<String> getMigrations() {
        return migrations;
    }

    public record Users1Result(String id, String name, String email) {}

    public List<Users1Result> users1() throws SQLException {
        try (var stmt = connection.prepareStatement("select * from users;")) {
            try (var rs = stmt.executeQuery()) {
                var results = new ArrayList<Users1Result>();
                while (rs.next()) {
                    results.add(
                        new Users1Result(
                            (String) rs.getObject(1),
                            (String) rs.getObject(2),
                            (String) rs.getObject(3)
                        )
                    );
                }
                return results;
            }
        }
    }

    public String users2() throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "select id from users where id = '1';"
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                return rs.next() ? (String) rs.getObject(1) : null;
            }
        }
    }

    public String users3() throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "select name from users where id = '1';"
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                return rs.next() ? (String) rs.getObject(1) : null;
            }
        }
    }

    public record Users4Result(String email, String name) {}

    public Users4Result users4() throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "select email, name from users where id = '1';"
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                return rs.next()
                    ? new Users4Result(
                          (String) rs.getObject(1),
                          (String) rs.getObject(2)
                      )
                    : null;
            }
        }
    }

    public record Users5Result(Integer count, String email) {}

    public List<Users5Result> users5() throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "select 10 count, email from users where id = '1';"
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                var results = new ArrayList<Users5Result>();
                while (rs.next()) {
                    results.add(
                        new Users5Result(
                            (Integer) rs.getObject(1),
                            (String) rs.getObject(2)
                        )
                    );
                }
                return results;
            }
        }
    }

    public record Users6Result(String id, String name, String email) {}

    public Users6Result users6(String name) throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "SELECT * FROM users WHERE name =?"
            )
        ) {
            stmt.setObject(1, name);
            try (var rs = stmt.executeQuery()) {
                return rs.next()
                    ? new Users6Result(
                          (String) rs.getObject(1),
                          (String) rs.getObject(2),
                          (String) rs.getObject(3)
                      )
                    : null;
            }
        }
    }

    public record Users7Result(String id, String name, String email) {}

    public List<Users7Result> users7(String name) throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "SELECT * FROM users WHERE name =?"
            )
        ) {
            stmt.setObject(1, name);
            try (var rs = stmt.executeQuery()) {
                var results = new ArrayList<Users7Result>();
                while (rs.next()) {
                    results.add(
                        new Users7Result(
                            (String) rs.getObject(1),
                            (String) rs.getObject(2),
                            (String) rs.getObject(3)
                        )
                    );
                }
                return results;
            }
        }
    }

    public record GetTasksByStatusResult(
        Integer id,
        String title,
        String status,
        List<String> tags,
        List<Integer> priorityScores
    ) {}

    public List<GetTasksByStatusResult> getTasksByStatus(String status)
        throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "SELECT id, title, status, tags, priority_scores FROM tasks WHERE status =?::task_status;"
            )
        ) {
            stmt.setObject(1, status);
            try (var rs = stmt.executeQuery()) {
                var results = new ArrayList<GetTasksByStatusResult>();
                while (rs.next()) {
                    results.add(
                        new GetTasksByStatusResult(
                            (Integer) rs.getObject(1),
                            (String) rs.getObject(2),
                            (String) rs.getObject(3),
                            arrayToList(
                                (Array) rs.getObject(4),
                                String[].class
                            ),
                            arrayToList(
                                (Array) rs.getObject(5),
                                Integer[].class
                            )
                        )
                    );
                }
                return results;
            }
        }
    }

    public record GetAllTasksResult(
        Integer id,
        String title,
        String status,
        List<String> tags,
        List<Integer> priorityScores
    ) {}

    public List<GetAllTasksResult> getAllTasks() throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "SELECT id, title, status, tags, priority_scores FROM tasks;"
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                var results = new ArrayList<GetAllTasksResult>();
                while (rs.next()) {
                    results.add(
                        new GetAllTasksResult(
                            (Integer) rs.getObject(1),
                            (String) rs.getObject(2),
                            (String) rs.getObject(3),
                            arrayToList(
                                (Array) rs.getObject(4),
                                String[].class
                            ),
                            arrayToList(
                                (Array) rs.getObject(5),
                                Integer[].class
                            )
                        )
                    );
                }
                return results;
            }
        }
    }

    public List<String> getTaskTags() throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "SELECT tags FROM tasks WHERE id = 1;"
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                return rs.next()
                    ? arrayToList((Array) rs.getObject(1), String[].class)
                    : null;
            }
        }
    }

    public List<Integer> getTaskPriorities() throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "SELECT priority_scores FROM tasks WHERE id = 1;"
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                return rs.next()
                    ? arrayToList((Array) rs.getObject(1), Integer[].class)
                    : null;
            }
        }
    }
}

// This file is generated by SQG (https://sqg.dev). Do not edit manually.
import { connect, type Database } from "@tursodatabase/database";

interface RunResult {
  changes: number;
  lastInsertRowid: number;
}

// Statement type inferred from Database.prepare()
type Statement = Awaited<ReturnType<Database["prepare"]>>;

export class Queries {
  private statements = new Map<string, Statement>();

  constructor(private db: Database) {}

  private async prepare(id: string, query: string): Promise<Statement> {
    let stmt = this.statements.get(id);
    if (!stmt) {
      stmt = await this.db.prepare(query);
      this.statements.set(id, stmt);
    }
    return stmt;
  }

  static getMigrations(): string[] {
    return [
      `CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    age INTEGER,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP
);`,
      `CREATE TABLE IF NOT EXISTS posts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    content TEXT,
    views INTEGER DEFAULT 0,
    published INTEGER DEFAULT 0,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);`,
      `CREATE INDEX IF NOT EXISTS idx_posts_user_id ON posts(user_id);
CREATE INDEX IF NOT EXISTS idx_posts_published ON posts(published);`,
    ];
  }

  static getQueryNames(): Map<string, keyof Queries> {
    return new Map([
      ["insertUser", "insertUser"],
      ["getAllUsers", "getAllUsers"],
      ["getUserById", "getUserById"],
      ["getUserByEmail", "getUserByEmail"],
      ["countUsers", "countUsers"],
      ["insertPost", "insertPost"],
      ["getPostsByUser", "getPostsByUser"],
      ["getPublishedPosts", "getPublishedPosts"],
      ["getPostWithAuthor", "getPostWithAuthor"],
      ["countPostsByUser", "countPostsByUser"],
      ["updatePostViews", "updatePostViews"],
      ["deletePost", "deletePost"],
    ]);
  }

  async insertUser(
    id: number,
    name: string,
    email: string,
    age: number,
  ): Promise<RunResult> {
    const stmt = await this.prepare(
      "insertUser",
      "INSERT INTO users (id, name, email, age) VALUES ( ?, ?, ?, ?);",
    );
    const result = await stmt.run(id, name, email, age);
    return result as RunResult;
  }
  async getAllUsers(): Promise<
    {
      id: number;
      name: string;
      email: string;
      age: number | null;
      created_at: string | null;
    }[]
  > {
    const stmt = await this.prepare(
      "getAllUsers",
      "SELECT id, name, email, age, created_at FROM users;",
    );
    return (await stmt.all()) as {
      id: number;
      name: string;
      email: string;
      age: number | null;
      created_at: string | null;
    }[];
  }
  async getUserById(
    id: number,
  ): Promise<
    | {
        id: number;
        name: string;
        email: string;
        age: number | null;
        created_at: string | null;
      }
    | undefined
  > {
    const stmt = await this.prepare(
      "getUserById",
      "SELECT id, name, email, age, created_at FROM users WHERE id =?;",
    );
    return (await stmt.get(id)) as
      | {
          id: number;
          name: string;
          email: string;
          age: number | null;
          created_at: string | null;
        }
      | undefined;
  }
  async getUserByEmail(
    email: string,
  ): Promise<
    | {
        id: number;
        name: string;
        email: string;
        age: number | null;
        created_at: string | null;
      }
    | undefined
  > {
    const stmt = await this.prepare(
      "getUserByEmail",
      "SELECT id, name, email, age, created_at FROM users WHERE email =?;",
    );
    return (await stmt.get(email)) as
      | {
          id: number;
          name: string;
          email: string;
          age: number | null;
          created_at: string | null;
        }
      | undefined;
  }
  async countUsers(): Promise<unknown | undefined> {
    const stmt = await this.prepare(
      "countUsers",
      "SELECT COUNT(*) FROM users;",
    );
    const row = (await stmt.get()) as Record<string, unknown> | undefined;
    return row ? Object.values(row)[0] : undefined;
  }
  async insertPost(
    userId: number,
    title: string,
    content: string,
    published: number,
  ): Promise<RunResult> {
    const stmt = await this.prepare(
      "insertPost",
      `INSERT INTO posts (user_id, title, content, published)
VALUES ( ?, ?, ?, ?);`,
    );
    const result = await stmt.run(userId, title, content, published);
    return result as RunResult;
  }
  async getPostsByUser(
    userId: number,
  ): Promise<
    {
      id: number;
      user_id: number;
      title: string;
      content: string | null;
      views: number | null;
      published: number | null;
      created_at: string | null;
    }[]
  > {
    const stmt = await this.prepare(
      "getPostsByUser",
      `SELECT id, user_id, title, content, views, published, created_at
FROM posts WHERE user_id =?;`,
    );
    return (await stmt.all(userId)) as {
      id: number;
      user_id: number;
      title: string;
      content: string | null;
      views: number | null;
      published: number | null;
      created_at: string | null;
    }[];
  }
  async getPublishedPosts(
    limit: number,
  ): Promise<
    {
      id: number;
      title: string;
      content: string | null;
      views: number | null;
      created_at: string | null;
      author_name: string;
    }[]
  > {
    const stmt = await this.prepare(
      "getPublishedPosts",
      `SELECT p.id, p.title, p.content, p.views, p.created_at, u.name as author_name
FROM posts p
JOIN users u ON p.user_id = u.id
WHERE p.published = 1
ORDER BY p.created_at DESC limit ?;`,
    );
    return (await stmt.all(limit)) as {
      id: number;
      title: string;
      content: string | null;
      views: number | null;
      created_at: string | null;
      author_name: string;
    }[];
  }
  async getPostWithAuthor(
    postId: number,
  ): Promise<
    | {
        id: number;
        title: string;
        content: string | null;
        views: number | null;
        created_at: string | null;
        author_id: number;
        author_name: string;
        author_email: string;
      }
    | undefined
  > {
    const stmt = await this.prepare(
      "getPostWithAuthor",
      `SELECT p.id, p.title, p.content, p.views, p.created_at,
       u.id as author_id, u.name as author_name, u.email as author_email
FROM posts p
JOIN users u ON p.user_id = u.id
WHERE p.id =?;`,
    );
    return (await stmt.get(postId)) as
      | {
          id: number;
          title: string;
          content: string | null;
          views: number | null;
          created_at: string | null;
          author_id: number;
          author_name: string;
          author_email: string;
        }
      | undefined;
  }
  async countPostsByUser(userId: number): Promise<unknown | undefined> {
    const stmt = await this.prepare(
      "countPostsByUser",
      "SELECT COUNT(*) FROM posts WHERE user_id =?;",
    );
    const row = (await stmt.get(userId)) as Record<string, unknown> | undefined;
    return row ? Object.values(row)[0] : undefined;
  }
  async updatePostViews(postId: number, views: number): Promise<RunResult> {
    const stmt = await this.prepare(
      "updatePostViews",
      "UPDATE posts SET views =? WHERE id =?;",
    );
    const result = await stmt.run(views, postId);
    return result as RunResult;
  }
  async deletePost(postId: number): Promise<RunResult> {
    const stmt = await this.prepare(
      "deletePost",
      "DELETE FROM posts WHERE id =?;",
    );
    const result = await stmt.run(postId);
    return result as RunResult;
  }
}

// This file is generated by SQG (https://sqg.dev). Do not edit manually.
import { DatabaseSync, StatementSync } from "node:sqlite";

interface RunResult {
  changes: number;
  lastInsertRowid: number;
}

export class Queries {
  private statements = new Map<string, StatementSync>();

  constructor(private db: DatabaseSync) {}

  private prepare(id: string, query: string) {
    let stmt = this.statements.get(id);
    if (!stmt) {
      stmt = this.db.prepare(query);
      this.statements.set(id, stmt);
    }
    return stmt;
  }

  static getMigrations(): string[] {
    return [
      `CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    age INTEGER,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP
);`,
      `CREATE TABLE IF NOT EXISTS posts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    content TEXT,
    views INTEGER DEFAULT 0,
    published INTEGER DEFAULT 0,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);`,
      `CREATE INDEX IF NOT EXISTS idx_posts_user_id ON posts(user_id);
CREATE INDEX IF NOT EXISTS idx_posts_published ON posts(published);`,
    ];
  }

  static getQueryNames(): Map<string, keyof Queries> {
    return new Map([
      ["insertUser", "insertUser"],
      ["getAllUsers", "getAllUsers"],
      ["getUserById", "getUserById"],
      ["getUserByEmail", "getUserByEmail"],
      ["countUsers", "countUsers"],
      ["insertPost", "insertPost"],
      ["getPostsByUser", "getPostsByUser"],
      ["getPublishedPosts", "getPublishedPosts"],
      ["getPostWithAuthor", "getPostWithAuthor"],
      ["countPostsByUser", "countPostsByUser"],
      ["updatePostViews", "updatePostViews"],
      ["deletePost", "deletePost"],
    ]);
  }

  insertUser(name: string, email: string, age: number): RunResult {
    const stmt = this.prepare(
      "insertUser",
      "INSERT INTO users (name, email, age) VALUES ( ?, ?, ?);",
    );
    return stmt.run(name, email, age) as RunResult;
  }
  getAllUsers(): {
    id: number;
    name: string;
    email: string;
    age: number | null;
    created_at: string | null;
  }[] {
    const stmt = this.prepare(
      "getAllUsers",
      "SELECT id, name, email, age, created_at FROM users;",
    );
    return stmt.all() as {
      id: number;
      name: string;
      email: string;
      age: number | null;
      created_at: string | null;
    }[];
  }
  getUserById(
    id: number,
  ):
    | {
        id: number;
        name: string;
        email: string;
        age: number | null;
        created_at: string | null;
      }
    | undefined {
    const stmt = this.prepare(
      "getUserById",
      "SELECT id, name, email, age, created_at FROM users WHERE id =?;",
    );
    return stmt.get(id) as
      | {
          id: number;
          name: string;
          email: string;
          age: number | null;
          created_at: string | null;
        }
      | undefined;
  }
  getUserByEmail(
    email: string,
  ):
    | {
        id: number;
        name: string;
        email: string;
        age: number | null;
        created_at: string | null;
      }
    | undefined {
    const stmt = this.prepare(
      "getUserByEmail",
      "SELECT id, name, email, age, created_at FROM users WHERE email =?;",
    );
    return stmt.get(email) as
      | {
          id: number;
          name: string;
          email: string;
          age: number | null;
          created_at: string | null;
        }
      | undefined;
  }
  countUsers(): unknown | undefined {
    const stmt = this.prepare("countUsers", "SELECT COUNT(*) FROM users;");
    const row = stmt.get() as Record<string, unknown> | undefined;
    return row ? Object.values(row)[0] : undefined;
  }
  insertPost(
    userId: number,
    title: string,
    content: string,
    published: number,
  ): RunResult {
    const stmt = this.prepare(
      "insertPost",
      `INSERT INTO posts (user_id, title, content, published)
VALUES ( ?, ?, ?, ?);`,
    );
    return stmt.run(userId, title, content, published) as RunResult;
  }
  getPostsByUser(
    userId: number,
  ): {
    id: number;
    user_id: number;
    title: string;
    content: string | null;
    views: number | null;
    published: number | null;
    created_at: string | null;
  }[] {
    const stmt = this.prepare(
      "getPostsByUser",
      `SELECT id, user_id, title, content, views, published, created_at
FROM posts WHERE user_id =?;`,
    );
    return stmt.all(userId) as {
      id: number;
      user_id: number;
      title: string;
      content: string | null;
      views: number | null;
      published: number | null;
      created_at: string | null;
    }[];
  }
  getPublishedPosts(
    limit: number,
  ): {
    id: number;
    title: string;
    content: string | null;
    views: number | null;
    created_at: string | null;
    author_name: string;
  }[] {
    const stmt = this.prepare(
      "getPublishedPosts",
      `SELECT p.id, p.title, p.content, p.views, p.created_at, u.name as author_name
FROM posts p
JOIN users u ON p.user_id = u.id
WHERE p.published = 1
ORDER BY p.created_at DESC limit ?;`,
    );
    return stmt.all(limit) as {
      id: number;
      title: string;
      content: string | null;
      views: number | null;
      created_at: string | null;
      author_name: string;
    }[];
  }
  getPostWithAuthor(
    postId: number,
  ):
    | {
        id: number;
        title: string;
        content: string | null;
        views: number | null;
        created_at: string | null;
        author_id: number;
        author_name: string;
        author_email: string;
      }
    | undefined {
    const stmt = this.prepare(
      "getPostWithAuthor",
      `SELECT p.id, p.title, p.content, p.views, p.created_at,
       u.id as author_id, u.name as author_name, u.email as author_email
FROM posts p
JOIN users u ON p.user_id = u.id
WHERE p.id =?;`,
    );
    return stmt.get(postId) as
      | {
          id: number;
          title: string;
          content: string | null;
          views: number | null;
          created_at: string | null;
          author_id: number;
          author_name: string;
          author_email: string;
        }
      | undefined;
  }
  countPostsByUser(userId: number): unknown | undefined {
    const stmt = this.prepare(
      "countPostsByUser",
      "SELECT COUNT(*) FROM posts WHERE user_id =?;",
    );
    const row = stmt.get(userId) as Record<string, unknown> | undefined;
    return row ? Object.values(row)[0] : undefined;
  }
  updatePostViews(postId: number, views: number): RunResult {
    const stmt = this.prepare(
      "updatePostViews",
      "UPDATE posts SET views =? WHERE id =?;",
    );
    return stmt.run(views, postId) as RunResult;
  }
  deletePost(postId: number): RunResult {
    const stmt = this.prepare("deletePost", "DELETE FROM posts WHERE id =?;");
    return stmt.run(postId) as RunResult;
  }
}

// This file is generated by SQG. Do not edit manually.
package generated;

import java.math.BigDecimal;
import java.math.BigInteger;
import java.sql.Array;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Struct;
import java.time.Instant;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.OffsetTime;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.UUID;
import java.util.function.Function;
import org.duckdb.DuckDBAppender;
import org.duckdb.DuckDBConnection;

public class Queries {

    private final Connection connection;

    public Queries(Connection connection) {
        this.connection = connection;
    }

    private static Object[] getObjectArray(Array array) {
        if (array == null) {
            return null;
        }
        try {
            return (Object[]) array.getArray();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    private static Object[] getAttr(Struct struct) {
        if (struct == null) {
            return null;
        }
        try {
            return struct.getAttributes();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    private static LocalDateTime toLocalDateTime(java.sql.Timestamp ts) {
        return ts != null ? ts.toLocalDateTime() : null;
    }

    private static LocalDate toLocalDate(java.sql.Date d) {
        return d != null ? d.toLocalDate() : null;
    }

    private static LocalTime toLocalTime(java.sql.Time t) {
        return t != null ? t.toLocalTime() : null;
    }

    private static <K> List<K> arrayToList(
        Array array,
        Class<? extends K[]> baseType
    ) {
        var objectArray = getObjectArray(array);
        if (objectArray == null) {
            return null;
        }
        return Collections.unmodifiableList(
            Arrays.asList(
                Arrays.copyOf(objectArray, objectArray.length, baseType)
            )
        );
    }

    private static <K> List<K> arrayOfStructToList(
        Array array,
        Function<Object[], K> convert
    ) {
        var objectArray = getObjectArray(array);
        if (objectArray == null) {
            return null;
        }
        var list = new ArrayList<K>(objectArray.length);
        for (Object obj : objectArray) {
            list.add(obj != null ? convert.apply(getAttr((Struct) obj)) : null);
        }
        return Collections.unmodifiableList(list);
    }

    @SuppressWarnings("unchecked")
    private static <K> List<List<K>> multiDimArrayToList(
        Array array,
        Class<? extends K[]> baseType
    ) {
        var objectArray = getObjectArray(array);
        if (objectArray == null) {
            return null;
        }
        var list = new ArrayList<List<K>>(objectArray.length);
        for (Object obj : objectArray) {
            if (obj == null) {
                list.add(null);
            } else if (obj instanceof Array) {
                list.add(arrayToList((Array) obj, baseType));
            } else if (obj instanceof Object[]) {
                var inner = (Object[]) obj;
                list.add(
                    Collections.unmodifiableList(
                        Arrays.asList(
                            Arrays.copyOf(inner, inner.length, baseType)
                        )
                    )
                );
            } else {
                throw new RuntimeException(
                    "Unexpected type in multi-dimensional array: " +
                        obj.getClass()
                );
            }
        }
        return Collections.unmodifiableList(list);
    }

    private static final List<String> migrations = List.of(
        """
        CREATE SEQUENCE IF NOT EXISTS seq_users_id START 1;
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY DEFAULT nextval('seq_users_id'),
            name TEXT NOT NULL,
            email TEXT UNIQUE NOT NULL,
            created_at TIMESTAMP DEFAULT current_timestamp
        );""",
        """
        CREATE SEQUENCE IF NOT EXISTS seq_posts_id START 1;
        CREATE TABLE IF NOT EXISTS posts (
            id INTEGER PRIMARY KEY DEFAULT nextval('seq_posts_id'),
            user_id INTEGER NOT NULL REFERENCES users(id),
            title TEXT NOT NULL,
            content TEXT,
            published BOOLEAN DEFAULT false,
            tags TEXT[],
            created_at TIMESTAMP DEFAULT current_timestamp
        );""",
        """
        CREATE TABLE IF NOT EXISTS topics (
            id INTEGER PRIMARY KEY,
            name TEXT NOT NULL,
            description TEXT,
            created_at TIMESTAMP
        );"""
    );

    public static List<String> getMigrations() {
        return migrations;
    }

    public record GetTopicsResult(
        Integer id,
        String name,
        String description,
        LocalDateTime createdAt
    ) {}

    public List<GetTopicsResult> getTopics() throws SQLException {
        try (var stmt = connection.prepareStatement("SELECT * from topics;")) {
            try (var rs = stmt.executeQuery()) {
                var results = new ArrayList<GetTopicsResult>();
                while (rs.next()) {
                    results.add(
                        new GetTopicsResult(
                            (Integer) rs.getObject(1),
                            (String) rs.getObject(2),
                            (String) rs.getObject(3),
                            toLocalDateTime(
                                (java.sql.Timestamp) rs.getObject(4)
                            )
                        )
                    );
                }
                return results;
            }
        }
    }

    public int insertUser(String name, String email) throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "INSERT INTO users (name, email) VALUES (?,?);"
            )
        ) {
            stmt.setObject(1, name);
            stmt.setObject(2, email);
            return stmt.executeUpdate();
        }
    }

    public record GetUsersResult(
        Integer id,
        String name,
        String email,
        LocalDateTime createdAt
    ) {}

    public List<GetUsersResult> getUsers() throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "SELECT id, name, email, created_at FROM users;"
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                var results = new ArrayList<GetUsersResult>();
                while (rs.next()) {
                    results.add(
                        new GetUsersResult(
                            (Integer) rs.getObject(1),
                            (String) rs.getObject(2),
                            (String) rs.getObject(3),
                            toLocalDateTime(
                                (java.sql.Timestamp) rs.getObject(4)
                            )
                        )
                    );
                }
                return results;
            }
        }
    }

    public record GetUserByIdResult(
        Integer id,
        String name,
        String email,
        LocalDateTime createdAt
    ) {}

    public GetUserByIdResult getUserById(Integer id) throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "SELECT id, name, email, created_at FROM users WHERE id =?;"
            )
        ) {
            stmt.setObject(1, id);
            try (var rs = stmt.executeQuery()) {
                return rs.next()
                    ? new GetUserByIdResult(
                          (Integer) rs.getObject(1),
                          (String) rs.getObject(2),
                          (String) rs.getObject(3),
                          toLocalDateTime((java.sql.Timestamp) rs.getObject(4))
                      )
                    : null;
            }
        }
    }

    public Long countUsers() throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                "SELECT COUNT(*) FROM users;"
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                return rs.next() ? (Long) rs.getObject(1) : null;
            }
        }
    }

    public int insertPost(
        Integer userId,
        String title,
        String content,
        Boolean published
    ) throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                """
                INSERT INTO posts (user_id, title, content, published, tags)
                VALUES (?,?,?,?, ['general']);"""
            )
        ) {
            stmt.setObject(1, userId);
            stmt.setObject(2, title);
            stmt.setObject(3, content);
            stmt.setObject(4, published);
            return stmt.executeUpdate();
        }
    }

    public record GetPostsByUserResult(
        Integer id,
        Integer userId,
        String title,
        String content,
        Boolean published,
        List<String> tags,
        LocalDateTime createdAt
    ) {}

    public List<GetPostsByUserResult> getPostsByUser(Integer userId)
        throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                """
                SELECT id, user_id, title, content, published, tags, created_at
                FROM posts WHERE user_id =?;"""
            )
        ) {
            stmt.setObject(1, userId);
            try (var rs = stmt.executeQuery()) {
                var results = new ArrayList<GetPostsByUserResult>();
                while (rs.next()) {
                    results.add(
                        new GetPostsByUserResult(
                            (Integer) rs.getObject(1),
                            (Integer) rs.getObject(2),
                            (String) rs.getObject(3),
                            (String) rs.getObject(4),
                            (Boolean) rs.getObject(5),
                            arrayToList(
                                (Array) rs.getObject(6),
                                String[].class
                            ),
                            toLocalDateTime(
                                (java.sql.Timestamp) rs.getObject(7)
                            )
                        )
                    );
                }
                return results;
            }
        }
    }

    public record GetPublishedPostsResult(
        Integer id,
        String title,
        String content,
        LocalDateTime createdAt,
        String authorName
    ) {}

    public List<GetPublishedPostsResult> getPublishedPosts()
        throws SQLException {
        try (
            var stmt = connection.prepareStatement(
                """
                SELECT p.id, p.title, p.content, p.created_at, u.name as author_name
                FROM posts p
                JOIN users u ON p.user_id = u.id
                WHERE p.published = true;"""
            )
        ) {
            try (var rs = stmt.executeQuery()) {
                var results = new ArrayList<GetPublishedPostsResult>();
                while (rs.next()) {
                    results.add(
                        new GetPublishedPostsResult(
                            (Integer) rs.getObject(1),
                            (String) rs.getObject(2),
                            (String) rs.getObject(3),
                            toLocalDateTime(
                                (java.sql.Timestamp) rs.getObject(4)
                            ),
                            (String) rs.getObject(5)
                        )
                    );
                }
                return results;
            }
        }
    }

    // ==================== Appenders ====================

    /** Create an appender for bulk inserts into topics */
    public TopicsAppender createTopicsAppender() throws SQLException {
        return new TopicsAppender(
            ((DuckDBConnection) connection).createAppender(
                DuckDBConnection.DEFAULT_SCHEMA,
                "topics"
            )
        );
    }

    /** Row type for topics appender */
    public record TopicsRow(
        Integer id,
        String name,
        String description,
        LocalDateTime created_at
    ) {}

    /** Appender for bulk inserts into topics */
    public static class TopicsAppender implements AutoCloseable {

        private final DuckDBAppender appender;

        TopicsAppender(DuckDBAppender appender) {
            this.appender = appender;
        }

        /** Get the underlying DuckDB appender for advanced operations */
        public DuckDBAppender getAppender() {
            return appender;
        }

        /** Append a single row */
        public TopicsAppender append(TopicsRow row) throws SQLException {
            appender.beginRow();
            appender.append(row.id());
            appender.append(row.name());
            appender.append(row.description());
            appender.append(row.created_at());
            appender.endRow();
            return this;
        }

        /** Append a single row with individual values */
        public TopicsAppender append(
            Integer id,
            String name,
            String description,
            LocalDateTime created_at
        ) throws SQLException {
            appender.beginRow();
            appender.append(id);
            appender.append(name);
            appender.append(description);
            appender.append(created_at);
            appender.endRow();
            return this;
        }

        /** Append multiple rows */
        public TopicsAppender appendMany(Iterable<TopicsRow> rows)
            throws SQLException {
            for (var row : rows) {
                append(row);
            }
            return this;
        }

        /** Flush and close the appender */
        @Override
        public void close() throws SQLException {
            appender.close();
        }
    }
}
